#!/bin/env bash

# Copyright (C) 2024 by Michael Schaecher <mschaecher78@gmail.com> under the MIT License

# This script generates /etc/fstab file for Ubuntu installation with btrfs filesystem
# that uses none Ubuntu default subvolumes.
#
# Gen-FSTab script assumes that system has EFI boot partition.

function subvol () {
	for su in $(btrfs su list /mnt | grep 'level 5' | awk '{print $9}'); do

		test -n "$su" || { echo "No subvolumes found"; exit 1; }

	    test "$su" = "root"      || test "${su}" = "@"          && mountAt="/"
	    test "$su" = "home"      || test "${su}" = "@home"      && mountAt="/home"
	    test "$su" = "cache"     || test "${su}" = "@cache"     && mountAt="/var/cache"
	    test "$su" = "log"       || test "${su}" = "@log"       && mountAt="/var/log"
	    test "$su" = "tmp"       || test "${su}" = "@tmp"       && mountAt="/tmp"
	    test "$su" = "snapshots" || test "${su}" = "@snapshots" && mountAt="/.snapshots"

	    echo "UUID=${ROOT_FS} $mountAt btrfs ${BTRFS_OPT},subvol=${su} 0 0"
	done
}

test "$(id -u)" -eq 0 || { echo "You must be root to run this script"; exit 1; }

BTRFS_OPT="ssd,noatime,space_cache=v2,compress=lzo"

BOOT_FS="$(lsblk -o uuid,fstype | grep 'vfat' | awk '{print $1}')"
ROOT_FS="$(lsblk -o uuid,fstype | grep 'btrfs' | awk '{print $1}')"
SWAP_FS="$(lsblk -o uuid,fstype | grep 'swap' | awk '{print $1}')"

# Check if there is no swap partition
test -z "${SWAP_FS}" && SWAP_FS="# UUID=" || SWAP_FS="UUID=${SWAP_FS}"

# Exit with error if no boot or root partition found
test -z "${BOOT_FS}" || test -z "${ROOT_FS}" && { echo "No boot or root partition found"; exit 1; }

cat <<EOF > /mnt/etc/fstab
# /etc/fstab: static file system information.
#
# This file was automatically generated by gen-fstab script. Please do not edit it manually.

# <file system>    <mount point>    <type>    <options>    <dump>    <pass>

# EFI boot partition
UUID=${BOOT_FS} /boot/efi vfat defaults 0 1

# Mount btrfs subvolumes
$(subvol)

# Swap partition
${SWAP_FS}
EOF

exit 0
